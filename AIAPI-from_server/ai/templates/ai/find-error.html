<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #content {
            height: 100%;
            width: 100%;
        }

        .think {
            background-color: #f0f8ff;
            border-left: 5px solid #4caf50;
            padding: 15px 20px;
            margin: 10px 0;
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        select {
            text-align: center;
        }

        h3 {
            margin: 0;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 5px;
        }

        h1,
        h2 {
            font-family: 'Roboto', sans-serif;
        }

        h1 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 2em;
            color: #555;
            margin-bottom: 15px;
        }

        .messageText {
            width: 100%;
            font-size: 18px;
            border: 2px solid #ccc;
            border-radius: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            resize: none;
            height: 20vh;
            margin-top: 5px;
            margin-bottom: 10px;
            padding: 10px;
            box-sizing: border-box;
        }

        button {
            padding: 6px 12px;
            margin: 3px;
            font-size: 14px;
            color: white;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        .voice-btn {
            margin: 3px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #messages {
            height: 94vh;
            width: 100vw;
            margin-left: 10px;
            margin-right: 10px;
            padding: 20px 0;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            font-family: 'Roboto', sans-serif;
            background-color: #fff;
        }

        #messages li {
            font-size: 18px;
        }

        .msg-user {
            background-color: #e6f0ff;
            border-left: 5px solid #3399ff;
        }

        .msg-assistant {
            background-color: #eaffea;
            border-left: 5px solid #4caf50;
        }

        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: background-color 0.2s ease;
            border-radius: 5px;
            margin: 3px;
        }

        .accordion-user {
            background-color: #3399ff;
            color: #fff;
        }

        .accordion-user.active, .accordion-user:hover {
            background-color: #1976d2;
        }

        .accordion-assistant {
            background-color: #4caf50;
            color: #fff;
        }

        .accordion-assistant.active, .accordion-assistant:hover {
            background-color: #357a38;
        }

        .panel {
            padding: 0 10px;
            display: none;
            background-color: white;
            overflow: hidden;
            border-radius: 0 0 5px 5px;
        }

        .panel.open {
            display: block;
        }

        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 80px 40px 200px 200px 2px 50px;
            margin-right: 1vw;
            padding-left: 40px;
            width: 30vw;
            max-width: 94vw;
            height: 100vh;
            gap: 0px;
            align-content: start;
        }

        #select,
        #selectType,
        #selectLang,
        #selectProgLng,
        #selectTheme,
        #selectPrompt {
            font-size: 18px;
            max-width: 77%;
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 110% */
        @media (min-resolution: 131dpi) and (max-resolution: 143dpi) {
            #select,
            #selectType,
            #selectLang,
            #selectProgLng,
            #selectTheme,
            #selectPrompt {
                transform: translateY(0px);
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 125% */
        @media (min-resolution: 144dpi) and (max-resolution: 150dpi) {
            #select,
            #selectType,
            #selectLang,
            #selectProgLng,
            #selectTheme,
            #selectPrompt {
                transform: translateY(0px);
            }
        }

        .blo {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .resize-button {
            left: 2;
            top: 13px;
            position: absolute;
            height: 98%;
            width: 30px;
            background-color: #d8d8d8;
            cursor: ew-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
            font-size: 32px;
            color: black;
        }

        .check {
            font-family: 'Roboto';
            font-weight: 600;
            display: flex;
        }

        .dv {
            display: flex;
        }

        .top-dv {
            display: flex;
            justify-content: space-between;
            grid-column: 1 / -1;
            grid-row: 1;
            align-self: end;
            margin-bottom: 10px;
        }

        .top-dv select {
            width: 48%;
        }

        .top-preprompt {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            grid-column: 1 / -1;
            grid-row: 2;
            align-self: start;
            margin-top: 0;
        }

        .task-section {
            grid-column: 1 / -1;
            grid-row: 3;
        }

        .code-section {
            grid-column: 1 / -1;
            grid-row: 4;
        }

        .toggle-button {
            margin: 0;
            padding: 0;
            position: absolute;
            top: 10px;
            right: 0;
            border: none;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
            height: 50px;
            background-color: rgb(207, 205, 205);
            border-radius: 30px 0 0 30px;
        }

        .toggle-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -30px;
            width: 30px;
            height: 100%;
            transition: all 0.3s ease;
            z-index: -1;
        }

        .toggle-button:hover {
            background-color: rgb(119, 119, 119);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .sidebar-content {
            padding: 15px;
            flex: 1;
        }

        .sidebar.open {
            transform: translateX(-300px);
        }

        .sidebar.open+.toggle-button {
            transform: translateX(-300px);
        }

        .toggle-button svg {
            transition: transform 0.3s ease;
            transform: rotate(180deg);
        }

        .sidebar.open+.toggle-button svg {
            transform: rotate(0deg);
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin: 0;
            margin-top: 300px;
            flex-wrap: wrap;
            grid-column: 1;
            grid-row: 7;
            align-self: start;
        }

        .voice-controls.active {
            display: flex;
        }

        .voice-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            font-size: 14px;
        }

        .voice-btn.recording {
            background-color: #ff4444;
            animation: pulse 1.5s infinite;
        }

        .voice-btn.speaking {
            background-color: #4caf50;
        }

        .voice-status {
            font-size: 14px;
            color: #666;
            margin: 2px 0;
            min-height: 0;
            grid-column: 1 / -1;
            grid-row: 5;
            align-self: end;
        }

        @keyframes pulse {
            0% { background-color: #ff4444; }
            50% { background-color: #ff6666; }
            100% { background-color: #ff4444; }
        }

        .voice-input-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #ff4444;
            border-radius: 50%;
            margin-right: 5px;
            opacity: 0;
        }

        .selectors-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 400px;
            grid-column: 2;
            grid-row: 7;
            align-self: start;
        }

        .voice-input-indicator.active {
            animation: voicePulse 0.8s infinite;
        }

        @keyframes voicePulse {
            0% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.3; transform: scale(0.8); }
        }

        .voice-mode-btn {
            margin: 10px;
            display: none;
        }

        .think-checkbox {
            display: flex;
            align-items: center;
            margin: 5px 10px;
            font-size: 14px;
        }

        .think-checkbox input {
            margin-right: 8px;
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 110% */
        @media (min-resolution: 131dpi) and (max-resolution: 143dpi) {
            .check-text {
                transform: translateY(-25px);
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 125% */
        @media (min-resolution: 144dpi) and (max-resolution: 150dpi) {
            .check-text {
                transform: translateY(-55px);
            }
        }

        .buttons-container {
            display: flex;
            gap: 10px;
            grid-column: 1;
            grid-row: 6;
            justify-self: start;
            align-self: start;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .buttons-container button {
            margin: 0;
        }

        @media (min-resolution: 95dpi) and (max-resolution: 105dpi) {
            .buttons-container {
                align-self: start;
                margin-top: 50px;
            }
        }

        @media (min-resolution: 106dpi) and (max-resolution: 118dpi) {
            .buttons-container {
                align-self: start;
                margin-top: 30px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 100% */
        @media (min-resolution: 119dpi) and (max-resolution: 130dpi) {
            .buttons-container {
                align-self: start;
                margin-top: 0px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 110%*/
        @media (min-resolution: 131dpi) and (max-resolution: 143dpi) {
            .buttons-container {
                align-self: start;
                margin-top: 15px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 125%*/
        @media (min-resolution: 144dpi) and (max-resolution: 150dpi) {
            .buttons-container {
                align-self: start;
                margin-top: -10px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 150% */
        @media (min-resolution: 160dpi) {
            form {
                grid-template-columns: 300px 1fr 1fr;
                grid-template-rows: 80px 40px 120px 120px 0px 50px 10px;

            }

            .messageText {
                height: 100px;
                margin-bottom: 0;
            }

            button {
                padding: 4px 8px;
                margin: 2px;
                font-size: 12px;
            }

            .buttons-container {
                grid-row: 6;
                margin-top: 20px;
            }

            .buttons-container button {
                flex: 1 1 auto;
                min-width: 80px;
            }

            .voice-status {
                grid-row: 5;
                align-self: end;
                margin-top: -23px;
            }

            .voice-controls {
                grid-column: 2;
                grid-row: 6;
                align-self: start;
                margin-top: 20px;
            }

            .voice-btn {
                font-size: 11px;
                white-space: nowrap;
                flex: 1 1 100%;
                padding: 4px 8px;
            }

            .selectors-container {
                grid-column: 3;
                grid-row: 6;
                align-self: start;
                margin-top: 20px;
            }

            .selectors-container select {
                font-size: 12px;
                padding: 4px;
            }

            .think-checkbox {
                font-size: 11px;
                white-space: nowrap;
                margin: 2px;
            }

            .think-checkbox input {
                margin-right: 4px;
            }

            #select,
            #selectType,
            #selectLang,
            #selectProgLng,
            #selectTheme,
            #selectPrompt {
                font-size: 12px;
                padding: 4px;
            }

            .top-dv {
                grid-row: 1;
            }
        }

        /* Media queries for voice-controls */
        @media (min-resolution: 95dpi) and (max-resolution: 105dpi) {
            .voice-controls {
                align-self: start;
                margin-top: 30px;
            }
        }

        @media (min-resolution: 106dpi) and (max-resolution: 118dpi) {
            .voice-controls {
                align-self: start;
                margin-top: 20px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 100% */
        @media (min-resolution: 119dpi) and (max-resolution: 130dpi) {
            .voice-controls {
                align-self: start;
                margin-top: -15px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 110% */
        @media (min-resolution: 131dpi) and (max-resolution: 143dpi) {
            .voice-controls {
                align-self: start;
                margin-top: 15px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 125% */
        @media (min-resolution: 144dpi) and (max-resolution: 150dpi) {
            .voice-controls {
                align-self: start;
                margin-top: -20px;
            }
        }

        @media (min-resolution: 151dpi) and (max-resolution: 160dpi) {
            .voice-controls {
                align-self: start;
                margin-top: 120px;
            }
        }

        /* Media queries for selectors-container */
        @media (min-resolution: 95dpi) and (max-resolution: 105dpi) {
            .selectors-container {
                align-self: start;
                margin-top: 0px;
            }
        }

        @media (min-resolution: 106dpi) and (max-resolution: 118dpi) {
            .selectors-container {
                align-self: start;
                margin-top: 0px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 100% */
        @media (min-resolution: 119dpi) and (max-resolution: 130dpi) {
            .selectors-container {
                align-self: start;
                margin-top: -15px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 110% */
        @media (min-resolution: 131dpi) and (max-resolution: 143dpi) {
            .selectors-container {
                align-self: start;
                margin-top: 25px;
            }
        }

        /* –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ 125% */
        @media (min-resolution: 144dpi) and (max-resolution: 150dpi) {
            .selectors-container {
                align-self: start;
                margin-top: -10px;
            }
        }

        @media (min-resolution: 151dpi) and (max-resolution: 160dpi) {
            .selectors-container {
                align-self: start;
                margin-top: 345px;
            }
        }

        .selectors-container select {
            width: 100%;
        }

        /* Responsive –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        @media (max-width: 1400px) {
            .dv {
                flex-direction: column;
                width: 100%;
            }

            form {
                width: 100% !important;
                padding-left: 10px;
                grid-template-rows: 80px 40px 180px 180px 2px 50px;
            }

            .resize-button {
                display: none;
            }
        }

        @media (max-width: 1024px) {
            .blo {
                flex-direction: column;

            }

            form {
                width: 100%;
                padding-left: 10px;
                grid-template-rows: 80px 40px 150px 150px 2px 50px;
            }

            .resize-button {
                display: none;
            }

            #messages {
                width: calc(100% - 20px);
                margin: 10px;
                height: 50vh;
                max-height: 50vh;
            }

            .messageText {
                height: 120px;
                max-height: 130px;
            }
        }

        @media (max-width: 768px) {
            #messages {
                height: 44vh;
                max-height: 45vh;
            }

            .messageText {
                height: 100px;
                max-height: 110px;
                font-size: 16px;
            }

            button, #select, #selectType, #selectLang, #selectProgLng, #selectTheme, #selectPrompt {
                font-size: 14px;
            }

            form {
                grid-template-rows: 100px 50px 120px 120px 2px 60px;
            }
        }
    </style>
    <title>DLAPI</title>
</head>

<body>
    <div id="content">
        <div class="blo">
            <ul id='messages'>
            </ul>
            <div class="dv">
                <div class="resize-button" onmousedown="startResize(event)">ü†î </div>
                <form action="" onsubmit="sendMessage(event)">
                    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä—ã –ø—Ä–µ–ø—Ä–æ–º–ø—Ç–æ–≤ -->
                    <div class="top-dv">
                        <select id="selectProgLng">
                        </select>
                        <select id="selectTheme">
                        </select>
                    </div>
                    <div class="top-preprompt">
                        <div class="preprompt">–ü—Ä–µ–ø—Ä–æ–º–ø—Ç:</div>
                        <select id="selectPrompt">
                        </select>
                    </div>

                    <!-- –ü–æ–ª—è –¥–ª—è –∑–∞–¥–∞—á–∏ –∏ –∫–æ–¥–∞ -->
                    <div class="task-section">
                        <h3 class="task">–ó–∞–¥–∞—á–∞:</h3>
                        <textarea type="text" id="taskText" class="messageText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏"
                            autocomplete="off"></textarea>
                    </div>

                    <div class="code-section">
                        <h3 class="codetx">–ö–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã:</h3>
                        <textarea type="text" id="codeText" class="messageText"
                            placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –∫–æ–¥ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏, –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–µ—Ä–Ω–∏—Ç–µ –∫–æ–¥ –≤ ```(–±—É–∫–≤–∞ –Å –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ)"
                            autocomplete="off"></textarea>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
                    <button type="button" class="voice-mode-btn" onclick="toggleVoiceControls()">
                        üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º
                    </button>

                    <!-- –ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div class="voice-controls" id="voiceControls">
                        <button type="button" class="voice-btn" id="voiceInputBtn" onclick="toggleVoiceInput()">
                            <span class="voice-input-indicator" id="voiceIndicator"></span>
                            üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
                        </button>
                        <button type="button" class="voice-btn" id="voiceOutputBtn" onclick="speakLastResponse()">
                            üîä –û–∑–≤—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
                        </button>
                        <button type="button" class="voice-btn" onclick="stopSpeech()">
                            ‚èπÔ∏è –°—Ç–æ–ø
                        </button>

                        <!-- –ß–µ–∫–±–æ–∫—Å –¥–ª—è think-—Ç–µ–≥–æ–≤ -->
                        <div class="think-checkbox">
                            <input type="checkbox" id="speakThinkContent" checked>
                            <label for="speakThinkContent">–û–∑–≤—É—á–∏–≤–∞—Ç—å think-–±–ª–æ–∫–∏</label>
                        </div>
                    </div>

                    <div class="voice-status" id="voiceStatus"></div>

                    <div class="buttons-container">
                        <button type="submit">Send</button>
                        <button type="button" onclick="clearContext()">Clear Context</button>
                    </div>

                    <div class="selectors-container">
                        <select id="selectLang">
                            <option language="Russian">–†—É—Å—Å–∫–∏–π</option>
                            <option language="English">English</option>
                            <option language="French">Fran√ßais</option>
                        </select>
                        <select id="select">
                            <option value="DeepSeek_R1_Distill_Llama_70B">DeepSeek-R1-Distill-Llama-70B</option>
                            <option value="DeepSeek_R1">DeepSeek-R1</option>
                            <option value="Llama_3_1_Tulu_3_405B">Llama-3.1-Tulu-3-405B</option>
                            <option value="Meta_Llama_3_1_70B_Instruct">Meta-Llama-3.1-70B-Instruct</option>
                            <option value="QwQ_32B">Qwen QwQ-32B</option>
                            <option value="Mixtral_8x22b">Mixtral-8x22b</option>
                        </select>
                        <select id="selectType"
                            onchange="document.location.href=this.querySelector('option:checked').dataset.link">
                            <option data-link="/ai/chat/">–ß–∞—Ç —Å DLAI</option>
                            <option data-link="/ai/solve-problem">–†–µ—à–∏ –∑–∞–¥–∞—á—É</option>
                            <option selected>–í —á—ë–º –æ—à–∏–±–∫–∞?</option>
                        </select>
                        <div class="check">
                            <div class="check-text"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="sidebar">
            <a href="/ai/admin" style="text-decoration: none; color: black;">
                <div class="sidebar-header">
                    –ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å
                </div>
            </a>
            <div class="sidebar-content">
            </div>
        </div>

        <button class="toggle-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        var ws = null;
        var client_id = generateClientId();
        var notEnter = false;

        var recognition = null;
        var isListening = false;
        var speechSynthesis = window.speechSynthesis;
        var currentUtterance = null;
        var speakThinkEnabled = true;

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è client_id
        function generateClientId() {
            return 'client_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
        function toggleVoiceControls() {
            const voiceControls = document.getElementById('voiceControls');
            voiceControls.classList.toggle('active');
            if (!voiceControls.classList.contains('active')) {
                stopSpeech();
                if (isListening && recognition) {
                    recognition.stop();
                }
            }
        }

        function initSpeechRecognition() {
            try {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

                const langSelect = document.getElementById('selectLang');
                const selectedLang = langSelect.options[langSelect.selectedIndex].getAttribute('language');
                recognition.lang = getSpeechLanguage(selectedLang);

                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceUI();
                    updateVoiceStatus('–°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å');
                };

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        document.getElementById('codeText').value = finalTranscript;
                        updateVoiceStatus('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ' + finalTranscript);
                    }
                };

                recognition.onerror = function(event) {
                    updateVoiceStatus('–û—à–∏–±–∫–∞: ' + event.error);
                };

                recognition.onend = function() {
                    isListening = false;
                    updateVoiceUI();
                    updateVoiceStatus('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                };
            } catch (error) {
                console.error('Speech Recognition not available:', error);
                updateVoiceStatus('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
            }
        }

        function getSpeechLanguage(lang) {
            const languages = {
                'Russian': 'ru-RU',
                'English': 'en-US',
                'French': 'fr-FR'
            };
            return languages[lang] || 'en-US';
        }

        function toggleVoiceInput() {
            if (!recognition) {
                initSpeechRecognition();
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
            } else {
                try {
                    const langSelect = document.getElementById('selectLang');
                    const selectedLang = langSelect.options[langSelect.selectedIndex].getAttribute('language');
                    recognition.lang = getSpeechLanguage(selectedLang);
                    recognition.start();
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                    updateVoiceStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞');
                }
            }
            updateVoiceUI();
        }

        function speakLastResponse() {
            const messages = document.getElementById('messages');
            const allMessages = messages.querySelectorAll('li');

            if (allMessages.length === 0) {
                updateVoiceStatus('–ù–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è');
                return;
            }

            const lastMessage = allMessages[allMessages.length - 1];
            let text = lastMessage.innerText || '';

            text = cleanSpeechText(text);

            if (!text.trim()) {
                updateVoiceStatus('–ù–µ—á–µ–≥–æ –æ–∑–≤—É—á–∏–≤–∞—Ç—å');
                return;
            }

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(text);

            const langSelect = document.getElementById('selectLang');
            const selectedLang = langSelect.options[langSelect.selectedIndex].getAttribute('language');
            currentUtterance.lang = getSpeechLanguage(selectedLang);
            currentUtterance.rate = 1;
            currentUtterance.pitch = 1;

            currentUtterance.onstart = function() {
                updateVoiceStatus('–û–∑–≤—É—á–∏–≤–∞—é...');
                document.getElementById('voiceOutputBtn').classList.add('speaking');
            };

            currentUtterance.onend = function() {
                updateVoiceStatus('–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                document.getElementById('voiceOutputBtn').classList.remove('speaking');
            };

            currentUtterance.onerror = function(event) {
                updateVoiceStatus('–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è');
                document.getElementById('voiceOutputBtn').classList.remove('speaking');
            };

            speechSynthesis.speak(currentUtterance);
        }

        function cleanSpeechText(text) {
            if (!text) return '';

            let cleanText = text;

            // –£–±–∏—Ä–∞–µ–º think-–±–ª–æ–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç—Ç–æ–≥–æ –Ω–µ —Ö–æ—á–µ—Ç
            if (!speakThinkEnabled) {
                cleanText = cleanText.replace(/<think>[\s\S]*?<\/think>/g, '');
            }

            cleanText = cleanText.replace(/–ü–æ–∫–∞–∑–∞—Ç—å:.*?(–°–∫—Ä—ã—Ç—å:|$)/g, '');
            cleanText = cleanText.replace(/–°–∫—Ä—ã—Ç—å:.*?(–ü–æ–∫–∞–∑–∞—Ç—å:|$)/g, '');

            cleanText = cleanText.replace(/<[^>]*>/g, '');

            const servicePatterns = [
                /\b(?:–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç|Assistant|Vous|–í—ã|User|–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)\s*:\s*/gi,
                /\b(?:–°–∫—Ä—ã—Ç—å|–ü–æ–∫–∞–∑–∞—Ç—å|Hide|Show)\s*:\s*/gi,
                /\b–ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω\b/gi,
                /\b–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\b/gi,
                /\bProcessing user request\b/gi,
                /\bRequest processed successfully\b/gi,
                /\b–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω\b/gi,
                /\bContext cleared\b/gi,
                /\b–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\b/gi,
                /\bConnection established\b/gi,
                /\b–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ\b/gi,
                /\bReady to work\b/gi,
                /\b–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ\b/gi,
                /\bMessage sent\b/gi,
                /\b–ü–æ–∫–∞–∑–∞—Ç—å:.*$/gm,
                /\b–°–∫—Ä—ã—Ç—å:.*$/gm
            ];

            servicePatterns.forEach(pattern => {
                cleanText = cleanText.replace(pattern, '');
            });

            cleanText = cleanText.replace(/\s+/g, ' ').trim();

            return cleanText;
        }

        function stopSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                updateVoiceStatus('–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }
            if (isListening && recognition) {
                recognition.stop();
            }
            document.getElementById('voiceOutputBtn').classList.remove('speaking');
        }

        function updateVoiceUI() {
            const voiceBtn = document.getElementById('voiceInputBtn');
            const voiceIndicator = document.getElementById('voiceIndicator');

            if (isListening) {
                voiceBtn.classList.add('recording');
                voiceIndicator.classList.add('active');
            } else {
                voiceBtn.classList.remove('recording');
                voiceIndicator.classList.remove('active');
            }
        }

        function updateVoiceStatus(message) {
            document.getElementById('voiceStatus').textContent = message;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        function initWebSocket() {
            try {
                var wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                var wsUrl = `${wsProtocol}//${window.location.host}/ai/chat/ws/${client_id}`;

                console.log('Connecting to WebSocket:', wsUrl);
                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    console.log('WebSocket connection established');
                };

                ws.onmessage = function (event) {
                    var messages = document.getElementById('messages');
                    var message = document.createElement('li');
                    var inThinkTag = document.createElement('div');
                    inThinkTag.classList.add('think');
                    inThinkTag.innerHTML = parseThinkTag(event.data).thinkContent;
                    var mainMess = document.createElement('div');
                    mainMess.innerHTML = parseThinkTag(event.data).remainingText;
                    const mainMessText = mainMess.innerText || "";
                    const parsedHTML = convertMarkdownToHTML(mainMessText);
                    const messageContent = document.createElement('div');
                    messageContent.innerHTML = parsedHTML;

                    // Accordion logic
                    const allMessages = messages.querySelectorAll(':scope > li');
                    const roles = [];
                    for (let i = 0; i < allMessages.length; i++) {
                        if (i % 2 === 0) roles.push('user');
                        else roles.push('assistant');
                    }

                    allMessages.forEach(function (li, idx) {
                        if (!li.classList.contains('accordion-li') && !li.querySelector('.accordion')) {
                            li.classList.add('accordion-li');
                            const role = roles[idx] || 'other';
                            li.classList.remove('msg-user', 'msg-assistant');
                            if (role === 'user') li.classList.add('msg-user');
                            if (role === 'assistant') li.classList.add('msg-assistant');

                            const btn = document.createElement('button');
                            btn.className = 'accordion';
                            if (role === 'user') btn.classList.add('accordion-user');
                            if (role === 'assistant') btn.classList.add('accordion-assistant');

                            const selectLang = document.getElementById('selectLang');
                            const langAttr = selectLang.options[selectLang.selectedIndex].getAttribute('language');
                            const roleLabels = {
                                Russian: { user: '–í—ã', assistant: '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', other: '–î—Ä—É–≥–∏' },
                                English: { user: 'You', assistant: 'Assistant', other: 'Others' },
                                French: { user: 'Vous', assistant: 'Assistant', other: 'Autres' }
                            };

                            function getRoleLabel(role, lang) {
                                return (roleLabels[lang] && roleLabels[lang][role]) ? roleLabels[lang][role] : role;
                            }

                            btn.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å: ${getRoleLabel(role, langAttr)}`;
                            const panel = document.createElement('div');
                            panel.className = 'panel';

                            while (li.firstChild) {
                                panel.appendChild(li.firstChild);
                            }
                            li.appendChild(btn);
                            li.appendChild(panel);

                            btn.addEventListener('click', function () {
                                panel.classList.toggle('open');
                                btn.classList.toggle('active');
                                btn.textContent = panel.classList.contains('open')
                                    ? `–°–∫—Ä—ã—Ç—å: ${getRoleLabel(role, langAttr)}`
                                    : `–ü–æ–∫–∞–∑–∞—Ç—å: ${getRoleLabel(role, langAttr)}`;
                            });
                        }
                    });

                    if (parseThinkTag(event.data).thinkContent) {
                        message.appendChild(inThinkTag);
                    }
                    message.appendChild(messageContent);
                    messages.appendChild(message);
                    messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
                    notEnter = false;

                    initAccordionForMessages();
                    collapseAllExceptLast();
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };

                ws.onclose = function(event) {
                    console.log('WebSocket connection closed');
                };

            } catch (error) {
                console.error('Error initializing WebSocket:', error);
            }
        }

        function parseThinkTag(inputText) {
            const thinkStartTag = '<think>';
            const thinkEndTag = '</think>';
            const startIdx = inputText.indexOf(thinkStartTag);
            const endIdx = inputText.indexOf(thinkEndTag);
            if (startIdx === -1 || endIdx === -1) {
                return {
                    thinkContent: '',
                    remainingText: inputText
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .trim()
                };
            }
            const thinkContent = inputText.substring(
                startIdx + thinkStartTag.length,
                endIdx
            );
            let remainingText =
                inputText.substring(0, startIdx) +
                inputText.substring(endIdx + thinkEndTag.length);
            remainingText = remainingText
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .trim();

            return {
                thinkContent: thinkContent.trim(),
                remainingText: remainingText
            };
        }

        function convertMarkdownToHTML(markdown) {
            markdown = markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            let codeBlocks = [];
            markdown = markdown.replace(/```([^\`]*)```/g, (match, code) => {
                const codeId = `%%CODEBLOCK${codeBlocks.length}%%`;
                codeBlocks.push(code);
                return codeId;
            });
            let inlineCodeBlocks = [];
            markdown = markdown.replace(/`([^`]+)`/g, (match, code) => {
                const codeId = `%%INLINECODE${inlineCodeBlocks.length}%%`;
                inlineCodeBlocks.push(code);
                return codeId;
            });
            markdown = markdown.replace(/^(#{1,6})\s*(.+)$/gm, (match, hashes, content) => {
                const level = hashes.length;
                return `<h${level}>${content}</h${level}>`;
            });
            markdown = markdown.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            markdown = markdown.replace(/\_\_([^\_]+)\_\_/g, '<strong>$1</strong>');
            markdown = markdown.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
            markdown = markdown.replace(/\_([^\_]+)\_/g, '<em>$1</em>');
            markdown = markdown.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
            markdown = markdown.replace(/^\s*\*\s*(.+)$/gm, '<ul><li>$1</li></ul>');
            markdown = markdown.replace(/^\s*\d+\.\s*(.+)$/gm, '<ol><li>$1</li></ol>');
            markdown = markdown.replace(/!\[([^\]]+)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" />');
            markdown = markdown.replace(/\n/g, '<br />');
            markdown = markdown.replace(/%%CODEBLOCK(\d+)%%/g, (match, index) => {
                return `<pre><code>${codeBlocks[index]}</code></pre>`;
            });
            markdown = markdown.replace(/%%INLINECODE(\d+)%%/g, (match, index) => {
                return `<code>${inlineCodeBlocks[index]}</code>`;
            });
            return markdown;
        }

        function sendMessage(event) {
            event.preventDefault();
            if (!ws) {
                console.log("WebSocket is not initialized");
                alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...");
                return;
            }

            if (ws.readyState !== WebSocket.OPEN) {
                console.log("WebSocket is not open. State:", ws.readyState);
                alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...");
                return;
            }

            var value = document.querySelector("#select").value;
            var language = document.querySelector("#selectLang").value;
            var taskInput = document.getElementById("taskText");
            var codeInput = document.getElementById("codeText");
            var progLng = document.querySelector("#selectProgLng").value;
            var preprompt = document.querySelector("#selectPrompt").value;

            if (!taskInput.value.trim() && !codeInput.value.trim()) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã");
                return;
            }

            ws.send(JSON.stringify({
                type: '3',
                message: taskInput.value,
                value: value,
                language: language,
                progLng: progLng,
                code: codeInput.value,
                preprompt: preprompt
            }));

            taskInput.value = '';
            codeInput.value = '';
        }

        function clearContext() {
            if (!ws) {
                console.log("WebSocket is not initialized");
                return;
            }

            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'clear_context' }));

                // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                var messages = document.getElementById('messages');
                messages.innerHTML = '';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—á–∏—Å—Ç–∫–µ
                var clearMessage = document.createElement('li');
                clearMessage.innerHTML = '<div style="color: green;">–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω</div>';
                messages.appendChild(clearMessage);
                messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });

            } else {
                console.log("WebSocket is not open. State:", ws.readyState);
                alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Enter
        document.addEventListener("keydown", function (event) {
            const checkbox = document.querySelector(".inp");
            if (event.key === "Enter" && checkbox.checked && !event.shiftKey && !notEnter) {
                notEnter = true;
                sendMessage(event);
            }
        });

        const toggleButton = document.querySelector('.toggle-button');
        const sidebar = document.querySelector('.sidebar');

        toggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        let isResizing = false;

        function startResize(event) {
            isResizing = true;
            window.addEventListener('mousemove', resize);
            window.addEventListener('mouseup', stopResize);
        }

        function resize(event) {
            if (isResizing) {
                const container = document.querySelector('form');
                const newWidth = container.getBoundingClientRect().right - event.clientX;
                const minWidth = 400;
                if (newWidth > minWidth) {
                    container.style.width = `${newWidth}px`;
                }
            }
        }

        function stopResize() {
            isResizing = false;
            window.removeEventListener('mousemove', resize);
            window.removeEventListener('mouseup', stopResize);
        }

        const localization = {
            Russian: {
                send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                clear: "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç",
                taskplace: "–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏",
                codeplace: "–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –∫–æ–¥ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏, –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–µ—Ä–Ω–∏—Ç–µ –∫–æ–¥ –≤ ```(–±—É–∫–≤–∞ –Å –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ)",
                adminPanel: "–ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å",
                chat: "–ß–∞—Ç —Å DLAI",
                decideTask: "–†–µ—à–∏ –∑–∞–¥–∞—á—É",
                findError: "–í —á—ë–º –æ—à–∏–±–∫–∞?",
                enterHint: "",
                preprompt: "–ü—Ä–µ–ø—Ä–æ–º–ø—Ç",
                task: "–ó–∞–¥–∞—á–∞",
                codetx: "–ö–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã",
                chooseLanguage: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫",
                chooseTheme: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É",
                choosePrompt: "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–ø—Ç"
            },
            English: {
                send: "Send",
                clear: "Clear Context",
                taskplace: "Paste the task description here",
                codeplace: "Enter your code for solving the problem here, for beautiful formatting wrap the code in ```",
                adminPanel: "Admin Panel",
                chat: "Chat with DLAI",
                decideTask: "Solve the task",
                findError: "What's the error?",
                enterHint: "Press Enter to send the question (Shift+Enter for a new line)",
                preprompt: "Preprompt",
                task: "Task",
                codetx: "Program code",
                chooseLanguage: "Choose language",
                chooseTheme: "Choose theme",
                choosePrompt: "Choose prompt"
            },
            French: {
                send: "Envoyer",
                clear: "Effacer le contexte",
                taskplace: "Collez la description de la t√¢che ici",
                codeplace: "Entrez votre code pour r√©soudre le probl√®me ici, pour un beau formatage, enveloppez le code dans ```",
                adminPanel: "Panneau Admin",
                chat: "Chat avec DLAI",
                decideTask: "R√©soudre la t√¢che",
                findError: "Quelle est l'erreur?",
                enterHint: "Appuyez sur Entr√©e pour envoyer la question (Shift+Enter pour une nouvelle ligne)",
                preprompt: "Pr√©-promp",
                task: "T√¢che",
                codetx: "Code du programme",
                chooseLanguage: "Choisir la langue",
                chooseTheme: "Choisir le th√®me",
                choosePrompt: "Choisir le prompt"
            }
        };

        document.getElementById("selectLang").addEventListener("change", function () {
            const selectedLang = this.options[this.selectedIndex].getAttribute("language");
            document.querySelector("button[type='submit']").textContent = localization[selectedLang].send;
            document.querySelector("button[type='button']").textContent = localization[selectedLang].clear;
            document.getElementById("taskText").setAttribute("placeholder", localization[selectedLang].taskplace);
            document.getElementById("codeText").setAttribute("placeholder", localization[selectedLang].codeplace);
            document.querySelector(".sidebar-header").textContent = localization[selectedLang].adminPanel;
            document.querySelector("#selectType option:nth-child(1)").textContent = localization[selectedLang].chat;
            document.querySelector("#selectType option:nth-child(2)").textContent = localization[selectedLang].decideTask;
            document.querySelector("#selectType option:nth-child(3)").textContent = localization[selectedLang].findError;
            document.querySelector(".check-text").textContent = localization[selectedLang].enterHint;
            document.querySelector(".preprompt").textContent = localization[selectedLang].preprompt;
            document.querySelector(".task").textContent = localization[selectedLang].task;
            document.querySelector(".codetx").textContent = localization[selectedLang].codetx;
            updateAccordionLabels();
        });

        function initAccordionForMessages() {
            const messages = document.getElementById('messages');
            const allMessages = messages.querySelectorAll(':scope > li');
            const roles = [];
            for (let i = 0; i < allMessages.length; i++) {
                if (i % 2 === 0) roles.push('user');
                else roles.push('assistant');
            }

            const selectLang = document.getElementById('selectLang');
            const langAttr = selectLang.options[selectLang.selectedIndex].getAttribute('language');
            const roleLabels = {
                Russian: { user: '–í—ã', assistant: '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', other: '–î—Ä—É–≥–∏' },
                English: { user: 'You', assistant: 'Assistant', other: 'Others' },
                French: { user: 'Vous', assistant: 'Assistant', other: 'Autres' }
            };

            function getRoleLabel(role, lang) {
                return (roleLabels[lang] && roleLabels[lang][role]) ? roleLabels[lang][role] : role;
            }

            allMessages.forEach(function (li, idx) {
                if (!li.classList.contains('accordion-li')) {
                    li.classList.add('accordion-li');
                    const role = roles[idx] || 'other';
                    li.classList.remove('msg-user', 'msg-assistant');

                    const btn = document.createElement('button');
                    if (role === 'user') li.classList.add('msg-user');
                    if (role === 'assistant') li.classList.add('msg-assistant');
                    btn.className = 'accordion';
                    if (role === 'user') btn.classList.add('accordion-user');
                    if (role === 'assistant') btn.classList.add('accordion-assistant');
                    btn.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å: ${getRoleLabel(role, langAttr)}`;

                    const panel = document.createElement('div');
                    panel.className = 'panel';

                    while (li.firstChild) {
                        panel.appendChild(li.firstChild);
                    }
                    li.appendChild(btn);
                    li.appendChild(panel);

                    btn.addEventListener('click', function () {
                        panel.classList.toggle('open');
                        btn.classList.toggle('active');
                        btn.textContent = panel.classList.contains('open')
                            ? `–°–∫—Ä—ã—Ç—å: ${getRoleLabel(role, langAttr)}`
                            : `–ü–æ–∫–∞–∑–∞—Ç—å: ${getRoleLabel(role, langAttr)}`;
                    });
                }
            });

            if (allMessages.length > 0) {
                const lastLi = allMessages[allMessages.length - 1];
                const lastBtn = lastLi.querySelector('.accordion');
                const lastPanel = lastLi.querySelector('.panel');
                if (lastBtn && lastPanel) {
                    lastPanel.classList.add('open');
                    lastBtn.classList.add('active');
                    const lastRole = roles[allMessages.length - 1] || 'other';
                    lastBtn.textContent = `–°–∫—Ä—ã—Ç—å: ${getRoleLabel(lastRole, langAttr)}`;
                }
            }

            window._accordionRoles = roles;
        }

        function updateAccordionLabels() {
            const selectLang = document.getElementById('selectLang');
            const langAttr = selectLang.options[selectLang.selectedIndex].getAttribute('language');
            const roleLabels = {
                Russian: { user: '–í—ã', assistant: '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', other: '–î—Ä—É–≥–∏' },
                English: { user: 'You', assistant: 'Assistant', other: 'Others' },
                French: { user: 'Vous', assistant: 'Assistant', other: 'Autres' }
            };

            function getRoleLabel(role, lang) {
                return (roleLabels[lang] && roleLabels[lang][role]) ? roleLabels[lang][role] : role;
            }

            const allMessages = document.getElementById('messages').querySelectorAll('li');
            const roles = window._accordionRoles || [];
            allMessages.forEach(function (li, idx) {
                const btn = li.querySelector('.accordion');
                const panel = li.querySelector('.panel');
                if (btn && panel) {
                    const role = roles[idx] || 'other';
                    btn.textContent = panel.classList.contains('open')
                        ? `–°–∫—Ä—ã—Ç—å: ${getRoleLabel(role, langAttr)}`
                        : `–ü–æ–∫–∞–∑–∞—Ç—å: ${getRoleLabel(role, langAttr)}`;
                }
            });
        }

        function collapseAllExceptLast() {
            const allMessages = document.getElementById('messages').querySelectorAll('li');
            const selectLang = document.getElementById('selectLang');
            const langAttr = selectLang.options[selectLang.selectedIndex].getAttribute('language');
            const roleLabels = {
                Russian: { user: '–í—ã', assistant: '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', other: '–î—Ä—É–≥–∏' },
                English: { user: 'You', assistant: 'Assistant', other: 'Others' },
                French: { user: 'Vous', assistant: 'Assistant', other: 'Autres' }
            };

            const roles = window._accordionRoles || [];
            function getRoleLabel(role, lang) {
                return (roleLabels[lang] && roleLabels[lang][role]) ? roleLabels[lang][role] : role;
            }

            allMessages.forEach((li, idx) => {
                const btn = li.querySelector('.accordion');
                const panel = li.querySelector('.panel');
                const role = roles[idx] || 'other';
                if (btn && panel) {
                    if (idx === allMessages.length - 1) {
                        panel.classList.add('open');
                        btn.classList.add('active');
                        btn.textContent = `–°–∫—Ä—ã—Ç—å: ${getRoleLabel(role, langAttr)}`;
                    } else {
                        panel.classList.remove('open');
                        btn.classList.remove('active');
                        btn.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å: ${getRoleLabel(role, langAttr)}`;
                    }
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —è–∑—ã–∫–æ–≤, —Ç–µ–º –∏ –ø—Ä–æ–º–ø—Ç–æ–≤
        document.addEventListener("DOMContentLoaded", async () => {
            const languageSelect = document.getElementById("selectProgLng");
            const topicSelect = document.getElementById("selectTheme");
            const promptSelect = document.getElementById("selectPrompt");

            async function fetchData(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('Fetched data:', data);
                    return data;
                } catch (error) {
                    console.error('Error fetching data:', error);
                    return [];
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π
            function selectFirstIfSingle(selectElement) {
                if (selectElement && selectElement.options.length === 1) {
                    selectElement.selectedIndex = 0;
                }
            }

            async function loadLanguages() {
                const languages = await fetchData("/ai/api/languages");
                languageSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</option>';
                if (languages && languages.length > 0) {
                    languages.forEach(lang => {
                        const option = new Option(lang.language_name, lang.id);
                        languageSelect.appendChild(option);
                    });
                }
                selectFirstIfSingle(languageSelect);
            }

            async function loadTopics(languageId) {
                const topics = await fetchData("/ai/api/topics");
                topicSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</option>';
                if (topics && topics.length > 0) {
                    const filteredTopics = topics.filter(topic => topic.programming_language == languageId);
                    filteredTopics.forEach(topic => {
                        const option = new Option(topic.topic_name, topic.id);
                        topicSelect.appendChild(option);
                    });
                }
                selectFirstIfSingle(topicSelect);
            }

            async function loadPrompts(topicId) {
                const prompts = await fetchData("/ai/api/prompts");
                promptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–ø—Ç</option>';
                if (prompts && prompts.length > 0) {
                    const filteredPrompts = prompts.filter(prompt => prompt.topic_id == topicId);
                    filteredPrompts.forEach(prompt => {
                        const option = new Option(prompt.prompt_name, prompt.id);
                        promptSelect.appendChild(option);
                    });
                }
                selectFirstIfSingle(promptSelect);
            }

            languageSelect.addEventListener("change", async () => {
                const languageId = parseInt(languageSelect.value);
                topicSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</option>';
                promptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–ø—Ç</option>';
                if (!isNaN(languageId)) {
                    await loadTopics(languageId);
                }
            });

            topicSelect.addEventListener("change", async () => {
                const topicId = parseInt(topicSelect.value);
                promptSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–ø—Ç</option>';
                if (!isNaN(topicId)) {
                    await loadPrompts(topicId);
                }
            });

            await loadLanguages();
        });

        window.onload = function () {
            console.log('Initializing WebSocket with client_id:', client_id);
            initWebSocket();
            initSpeechRecognition();
            document.getElementById("selectLang").dispatchEvent(new Event("change"));
            initAccordionForMessages();
            updateVoiceStatus('');

            const speakThinkCheckbox = document.getElementById('speakThinkContent');
            speakThinkCheckbox.addEventListener('change', function() {
                speakThinkEnabled = this.checked;
            });
        };
    </script>
</body>
</html>